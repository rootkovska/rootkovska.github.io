---
layout: post
title: Handy Tool To Play with Windows Integrity Levels
date: '2007-03-05T18:53:00.001+01:00'
author: Joanna Rutkowska
tags: 
modified_time: '2009-03-25T16:07:15.128+01:00'
blogger_id: tag:blogger.com,1999:blog-24586388.post-1586021214114399750
blogger_orig_url: http://theinvisiblethings.blogspot.com/2007/03/handy-tool-to-play-with-windows.html
---

<a href="http://www.minasi.com/">Mark Minasi</a> wrote to me recently to point out that his new tool, <a href="http://www.minasi.com/vista/chml.htm">chml</a>, is capable of setting NoReadUp and NoExecuteUp policy on file objects, in addition to the standard NoWriteUp policy, which is used by default on Vista.<br /><br />As I wrote <a href="http://theinvisiblethings.blogspot.com/2007/02/running-vista-every-day.html">before </a> the default IL policy used on Vista assumes only the NoWriteUp policy. That means that all objects which do not have assigned any IL explicitly (and consequently are treated as if they were marked with Medium IL) can be read by low integrity processes (only writes are prevented). Also, the standard Windows <span style="font-family:courier new;">icacls </span>command, which allows to set IL for file objects, assumes always the NoWriteUp policy only (unless I’m missing some secret switch).<br /><br />However, it’s possible, for each object, to define not only the integrity level but also the policy which will be used to access it. All this information is stored in the same SACE which also defines the IL.<br /><br />There doesn’t seem to be too much documentation from Microsoft about how to set those permissions, except <a href="http://msdn.microsoft.com/library/en-us/ietechcol/dnwebgen/protectedmode.asp?frame=true#dse_lores">this paper about Protected Mode IE</a> and the <span style="font-family:courier new;">sddl.h</span> file itself.<br /><br />Anyway, it’s good to see a tool like <span style="font-family: courier new;">chml<span style="font-family: times new roman;"> </span></span>as it allows to do some cool things in a very simple way. E.g. consider that you have some secret documents in the folder <span style="font-family: courier new;">c:\secretes</span> and that you don’t feel like sharing those files with anybody who can exploit your Protected Mode IE. As I pointed out in my previous article, by default all your personal files are accessible to your Protected Mode IE low integrity process, so in the event of successful exploitation the attacker is free to steal them all. However now, using Mark Minasi’s tool, you can just do this:<br /><pre>chml.exe c:\secrets -i:m -nr -nx<br /></pre>This should prevent all the low IL processes, like e.g. Protected Mode IE, from reading the contents of your secret directory.<br /><br />BTW, you can use <span style="font-family: courier new;">chml</span> to also examine the SACE which was created:<br /><pre>chml.exe c:\secrets -showsddl<br /></pre>and you should get something like that as a result:<br /><pre>SDDL string for c:\secrets's integrity label=S:(ML;OICI;NRNX;;;ME)<br /></pre>Where S means that it’s an SACE (in contrast to e.g. DACE), ML says that this ACE defines mandatory label, OICI means “Object Inherit” and “Container Inherit”, NRNX defines that to access this object the NoReadUp and NoExecuteUp policies should be used (which also implies the NoWriteUp BTW) and finally the ME stands for Medium Integrity Level.<br /><br />All credits go to Mark Minasi and the Windows IL team :)<br /><br />As a side note: the updated slides for my recent Black Hat DC talk about cheating hardware based memory acquisition can be found <a href="http://invisiblethings.org/papers/cheating-hardware-memory-acquisition-updated.ppt">here</a>. You can also get the demo movies <a href="http://invisiblethings.org/papers/DMA-cheating-demo-bh-fed07.rar">here</a>.