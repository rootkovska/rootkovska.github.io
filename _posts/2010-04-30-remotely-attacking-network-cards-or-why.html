---
layout: post
title: Remotely Attacking Network Cards (or why we do need VT-d and TXT)
date: '2010-04-30T14:03:00.005+02:00'
author: Joanna Rutkowska
tags:
- attack
- tpm
- trusted execution technology
- trusted computing
- fighting for a better world
modified_time: '2010-05-13T14:26:11.485+02:00'
blogger_id: tag:blogger.com,1999:blog-24586388.post-2572700386184621224
blogger_orig_url: http://theinvisiblethings.blogspot.com/2010/04/remotely-attacking-network-cards-or-why.html
---

I've finally found some time to study Loic Duflot's and Yves-Alexis Perez's recent presentation from the last month on remotely attacking network cards. You can get the slides <a href="http://www.ssi.gouv.fr/IMG/pdf/csw-trustnetworkcard.pdf">here</a>.<br /><br />In short, they're exploiting a buffer overflow in the network card's firmware by sending malicious packets to the card, and then they gain full control over the card's firmware, so they can e.g. issue DMA to/from the host memory, effectively fully controlling the host (that's another example of <a href="http://invisiblethingslab.com/resources/bh09usa/Ring%20-3%20Rootkits.pdf">"Ring -3 rootkit"</a> I would say). The buffer overflow is in some exotic management protocol (that I think is disabled by default, but that's irrelevant) implemented by the NIC's firmware (the NIC has its own RISC processor, and memory, and stack, which they overflow, etc.).<br /><br />I like this research very much, because it demonstrates several important things:<br /><br />First, it shows that it is definitely a good idea to isolate/sandbox all the OS networking code using IOMMU/VT-d. And this is exactly what we do in <a href="http://www.qubes-os.org/Architecture.html">Qubes</a>.<br /><br />Second, the attack provides a real-world example of why Static Root for Trust Measurement (SRTM) is inferior to Dynamic RTM (DRTM), e.g. Intel TXT. To understand why, let's make the following assumptions:<br />1) The OS/VMM properly uses IOMMU to isolate the network card(s), just like e.g. Qubes does.<br />2) Once the attacker got control over the NIC firmware, the attacker can also modify the persistent storage (EEPROM) where this firmware is kept. This has been confirmed by Loic in a private email exchange.<br />3) The system implements trusted boot via SRTM, i.e. using just BIOS and TPM, without Intel TXT.<br /><br />Now, the attacker can modify the firmware in the EEPROM and this will allow the attacker to survive the platform reboot. The card's firmware will start executing early in the boot process, definitely before the OS/VMM gets loaded. Now, the compromised NIC, because it is capable of doing DMA to the host memory, can compromise the image of the VMM in a short time window between the time it got measured and loaded by the (trusted) OS loader, e.g. Trusted GRUB, but still before the time VMM had a chance to setup proper IOMMU/VT-d protections for itself.<br /><br />Of course, in practice, it might be tricky for the compromised NIC firmware to precisely know this time window when it should send a compromising DMA write request. If the DMA was issued too early, then the trusted OS loader would calculate a wrong hash and put a wrong value into a PCR register, which would later prevent the system from completing the boot, and prevent the attack. If the DMA was issued too late, the IOMMU/VT-d protections would already be in-place, and the attack would again be unsuccessful. But, hey, much harder obstacles have been worked around by smart exploit writes in the past, so don't comfort yourself that the attack is hard. If it's possible, it means this technology is flawed, period.<br /><br />And this is where DRTM, AKA Intel TXT, shows its advantage over simple SRTM. When you load a hypervisor using TXT, the SENTER instruction would first apply the VT-d protections around the hypervsior image, then do the measurements, and only then load it, with VT-d protections still in-place. <br /><br />The above is the theory. A few months ago we demonstrated an <a href="http://invisiblethingslab.com/resources/misc09/Another%20TXT%20Attack.pdf">attack against this scheme</a>, but the attack was exploiting a flaw in the TXT implementation, not in its design, so it didn't render TXT useless as a technology.<br /><br />A much bigger problem with Intel TXT is, that Intel still has done nothing to prevent SMM-based attacks against TXT. This is what we <a href="http://invisiblethingslab.com/press/itl-press-2009-01.pdf">demonstrated</a> about 1.5 years(!) ago. Our research stressed that TXT without protection from SMM is essentially useless. Intel then promised to come up with a spec on how to write an STM, and how TXT should work with STM (when to measure/load it, etc), but nothing has been released by Intel for all this time AFAIK...<br /><br />Now, without STM (which is supposed to provide protection from potentially compromised SMM), the TXT cannot really prevent Loic and friends from owning the system, even if it uses such a securely designed OS as Qubes. This is because Loic would be able to modify e.g. the MBR while the system boots (thanks to DMA ability of the infected NIC firmware), and then attack an SMM from this MBR (I can bet lots of money Loic & co. would easily find a few other SMM exploits in any recent BIOS if they only wanted to), and then having infected the SMM, they will be able to compromise TXT-loaded hypervisor, and finally compromise the whole system.<br /><br />I know there are some people from various governments reading this blog. If you really want to have secure systems, consider pushing on Intel to finally do something about the SMM-based attacks against TXT. Beware, Intel will try to tell you that, using TXT LCP you can seal your secrets to only "trusted" SMM images and would try to convince you it's a way to prevent SMM attacks on TXT. It is not. Only true SMM sandboxing is a proper way to address this problem.<br /><br />Anyway, congrats to Loic and colleagues for yet another very interesting and meaningful system-level research!